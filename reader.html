<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ß–∏—Ç–∞–ª–∫–∞</title>
    <link rel="stylesheet" href="css/style.css">
    <script src="pdfjs/pdf.js"></script>
    <style>
        #pdfViewer {
            width: 100%;
            min-height: 70vh;
            border: 1px solid #ddd;
            border-radius: 10px;
            overflow: auto;
            margin: 20px 0;
            display: flex;
            justify-content: center;
            align-items: center;
            background: #f9f9f9;
        }
        
        #pdfViewer canvas {
            display: block;
            margin: 0 auto;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-radius: 8px;
        }
        
        .controls {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
            padding: 15px;
            background: #f5f5f5;
            border-radius: 10px;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .control-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .controls button {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }
        
        .controls button:hover {
            background: #764ba2;
            transform: translateY(-2px);
        }
        
        .controls button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .back-btn {
            background: #6c757d;
        }
        
        .back-btn:hover {
            background: #5a6268;
        }
        
        .book-info {
            margin-bottom: 20px;
        }
        
        .book-info h2 {
            color: #667eea;
            margin-bottom: 5px;
            font-size: 1.8em;
        }
        
        .book-info p {
            color: #666;
            font-size: 1.1em;
        }
        
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 70vh;
            text-align: center;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error-message {
            background: #fff3f3;
            border-left: 4px solid #ff4444;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
        }
        
        .error-message h3 {
            color: #d32f2f;
            margin-top: 0;
        }
        
        .error-message p {
            color: #555;
            line-height: 1.6;
        }
        
        .page-info {
            font-weight: bold;
            min-width: 120px;
            text-align: center;
            font-size: 1.1em;
        }
        
        .zoom-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .zoom-value {
            min-width: 50px;
            text-align: center;
            font-weight: bold;
        }
        
        .theme-toggle {
            background: #4facfe;
        }
        
        .theme-toggle:hover {
            background: #3c89d8;
        }
        
        body.dark-theme {
            background: #1a1a1a;
            color: #e0e0e0;
        }
        
        body.dark-theme #readerContainer {
            background: #2d2d2d;
            color: #e0e0e0;
        }
        
        body.dark-theme .controls {
            background: #3a3a3a;
        }
        
        body.dark-theme #pdfViewer {
            background: #1a1a1a;
        }
        
        body.dark-theme .book-info h2 {
            color: #9b89ff;
        }
        
        body.dark-theme .book-info p {
            color: #bbb;
        }
        
        #readerContainer {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        @media (max-width: 768px) {
            .controls {
                flex-direction: column;
                align-items: center;
            }
            
            #readerContainer {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div id="readerContainer">
        <div class="book-info">
            <h2 id="bookTitle">–ó–∞–≥—Ä—É–∑–∫–∞ –∫–Ω–∏–≥–∏...</h2>
            <p id="bookAuthor"></p>
        </div>
        
        <div id="pdfViewer">
            <div class="loading">
                <div class="spinner"></div>
                <p>–ü–æ–¥–æ–∂–¥–∏—Ç–µ, –∫–Ω–∏–≥–∞ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è...</p>
            </div>
        </div>
        
        <div class="controls">
            <div class="control-group">
                <button class="back-btn" onclick="goBack()">‚Üê –ù–∞–∑–∞–¥ –≤ –±–∏–±–ª–∏–æ—Ç–µ–∫—É</button>
                <button onclick="toggleTheme()">üåô –ù–æ—á–Ω–æ–π —Ä–µ–∂–∏–º</button>
            </div>
            
            <div class="control-group">
                <button onclick="prevPage()">‚Üê –ü—Ä–µ–¥—ã–¥—É—â–∞—è</button>
                <span class="page-info" id="pageInfo">–°—Ç—Ä–∞–Ω–∏—Ü–∞ 1</span>
                <button onclick="nextPage()">–°–ª–µ–¥—É—é—â–∞—è ‚Üí</button>
            </div>
            
            <div class="control-group">
                <button onclick="zoomOut()">-</button>
                <span class="zoom-value" id="zoomValue">150%</span>
                <button onclick="zoomIn()">+</button>
            </div>
            
            <div class="control-group">
                <button onclick="downloadBook()">‚¨áÔ∏è –°–∫–∞—á–∞—Ç—å –∫–Ω–∏–≥—É (PDF)</button>
            </div>
        </div>
    </div>

    <script>
        let currentBook = null;
        let pdfDoc = null;
        let currentPage = 1;
        let scale = 1.5;
        let isDarkTheme = false;

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ worker –¥–ª—è PDF.js
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'pdfjs/pdf.worker.js';

        // –ó–∞–≥—Ä—É–∑–∫–∞ –∫–Ω–∏–≥–∏
        function loadBook() {
            const urlParams = new URLSearchParams(window.location.search);
            const bookId = urlParams.get('id');
            
            if (!bookId) {
                showError('–û—à–∏–±–∫–∞: –Ω–µ —É–∫–∞–∑–∞–Ω–∞ –∫–Ω–∏–≥–∞');
                return;
            }
            
            fetch('books.json')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö –∫–Ω–∏–≥');
                    }
                    return response.json();
                })
                .then(data => {
                    const book = data.books.find(b => b.id === bookId);
                    if (book) {
                        currentBook = book;
                        document.getElementById('bookTitle').textContent = book.title;
                        document.getElementById('bookAuthor').textContent = `–ê–≤—Ç–æ—Ä: ${book.author}`;
                        
                        // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–æ–∫—É–º–µ–Ω—Ç PDF
                        const loadingTask = pdfjsLib.getDocument(book.pdfUrl);
                        loadingTask.promise.then(function(pdf) {
                            pdfDoc = pdf;
                            updatePageInfo();
                            renderPage(currentPage);
                        }).catch(function(error) {
                            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞:', error);
                            showError('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–Ω–∏–≥—É: ' + error.message + 
                                '<br><br><strong>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–∫–∞—á–∞—Ç—å –∫–Ω–∏–≥—É:</strong>');
                            addDownloadButton();
                        });
                    } else {
                        showError('–ö–Ω–∏–≥–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö');
                    }
                })
                .catch(error => {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö:', error);
                    showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö: ' + error.message);
                });
        }
        
        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        function renderPage(pageNumber) {
            if (!pdfDoc) return;
            
            pdfDoc.getPage(pageNumber).then(function(page) {
                const viewport = page.getViewport({ scale: scale });
                
                // –°–æ–∑–¥–∞–µ–º –∫–∞–Ω–≤–∞—Å
                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d');
                canvas.height = viewport.height;
                canvas.width = viewport.width;
                
                // –û—á–∏—â–∞–µ–º –æ–±–ª–∞—Å—Ç—å –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∏ –¥–æ–±–∞–≤–ª—è–µ–º –∫–∞–Ω–≤–∞—Å
                const pdfViewer = document.getElementById('pdfViewer');
                pdfViewer.innerHTML = '';
                pdfViewer.appendChild(canvas);
                
                // –†–µ–Ω–¥–µ—Ä–∏–º —Å—Ç—Ä–∞–Ω–∏—Ü—É
                const renderContext = {
                    canvasContext: context,
                    viewport: viewport
                };
                
                page.render(renderContext);
                updatePageInfo();
            });
        }
        
        // –ù–∞–≤–∏–≥–∞—Ü–∏—è
        function prevPage() {
            if (currentPage > 1) {
                currentPage--;
                renderPage(currentPage);
            }
        }
        
        function nextPage() {
            if (currentPage < pdfDoc.numPages) {
                currentPage++;
                renderPage(currentPage);
            }
        }
        
        // –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ
        function zoomIn() {
            scale += 0.2;
            if (scale > 3.0) scale = 3.0;
            updateZoomValue();
            renderPage(currentPage);
        }
        
        function zoomOut() {
            scale -= 0.2;
            if (scale < 0.5) scale = 0.5;
            updateZoomValue();
            renderPage(currentPage);
        }
        
        function updateZoomValue() {
            const zoomValue = document.getElementById('zoomValue');
            zoomValue.textContent = Math.round(scale * 100) + '%';
        }
        
        function updatePageInfo() {
            const pageInfo = document.getElementById('pageInfo');
            pageInfo.textContent = `–°—Ç—Ä–∞–Ω–∏—Ü–∞ ${currentPage} –∏–∑ ${pdfDoc.numPages}`;
        }
        
        // –ù–æ—á–Ω–æ–π —Ä–µ–∂–∏–º
        function toggleTheme() {
            isDarkTheme = !isDarkTheme;
            document.body.classList.toggle('dark-theme', isDarkTheme);
            const button = event.target;
            button.textContent = isDarkTheme ? '‚òÄÔ∏è –î–Ω–µ–≤–Ω–æ–π —Ä–µ–∂–∏–º' : 'üåô –ù–æ—á–Ω–æ–π —Ä–µ–∂–∏–º';
        }
        
        // –û—à–∏–±–∫–∏
        function showError(message) {
            const pdfViewer = document.getElementById('pdfViewer');
            pdfViewer.innerHTML = `
                <div class="error-message">
                    <h3>‚ö†Ô∏è –û—à–∏–±–∫–∞</h3>
                    <p>${message}</p>
                    <p style="color: #777; margin-top: 15px; font-size: 14px;">
                        –ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ –Ω–µ —Ä–µ—à–∞–µ—Ç—Å—è, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–∫–∞—á–∞—Ç—å –∫–Ω–∏–≥—É –∏–ª–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É —Å–∞–π—Ç–∞.
                    </p>
                </div>
            `;
        }
        
        function addDownloadButton() {
            const downloadBtn = document.createElement('button');
            downloadBtn.textContent = '‚¨áÔ∏è –°–∫–∞—á–∞—Ç—å –∫–Ω–∏–≥—É (PDF)';
            downloadBtn.style.cssText = `
                background: #4CAF50;
                color: white;
                border: none;
                padding: 12px 24px;
                border-radius: 25px;
                cursor: pointer;
                font-size: 16px;
                margin-top: 15px;
                transition: all 0.3s;
            `;
            downloadBtn.onclick = downloadBook;
            
            document.querySelector('.error-message').appendChild(downloadBtn);
        }
        
        function goBack() {
            window.location.href = 'index.html';
        }
        
        function downloadBook() {
            if (currentBook && currentBook.pdfUrl) {
                const link = document.createElement('a');
                link.href = currentBook.pdfUrl;
                link.download = currentBook.title + '.pdf';
                link.click();
            } else {
                alert('–°—Å—ã–ª–∫–∞ –Ω–∞ –∫–Ω–∏–≥—É –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞');
            }
        }
        
        // –ó–∞–≥—Ä—É–∑–∏—Ç—å –∫–Ω–∏–≥—É –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.addEventListener('DOMContentLoaded', loadBook);
    </script>
</body>
</html>
